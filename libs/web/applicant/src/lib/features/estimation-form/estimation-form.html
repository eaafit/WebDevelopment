<div class="app-estimation-form-page">
  <main class="container page">
    <section class="card">
      <header class="card__header">
        <h1 class="card__title">Заявка на оценку</h1>
        <p class="card__subtitle">Заполните характеристики недвижимости для формирования заявки на оценку.</p>
      </header>

      <form
        #valuationForm
        class="form"
        id="valuationForm"
        novalidate
        [class.form--submitted]="showValidationErrors"
        (submit)="onSubmit($event, valuationForm, confirmCorrect.checked, confirmProcessing.checked)">
        @if (showValidationErrors) {
        <p class="form-error-text">
          {{ validationErrorMessage || 'Заполните обязательные поля, отмеченные символом *.' }}
        </p>
        }

        <div class="form__sections">
          <fieldset class="fieldset">
            <legend class="legend">Адрес</legend>

            <div class="form-block grid grid--2">
              <div class="field">
                <label class="label" for="city">Город <span class="req">*</span></label>
                <select
                  #cityField
                  class="control"
                  id="city"
                  name="city"
                  required
                  [class.control--invalid]="showValidationErrors && !cityField.validity.valid">
                  <option value="" selected disabled>Выберите город</option>
                  <option>Москва</option>
                  <option>Санкт-Петербург</option>
                  <option>Казань</option>
                  <option>Екатеринбург</option>
                  <option>Новосибирск</option>
                </select>
                @if (showValidationErrors && cityField.validity.valueMissing) {
                <p class="field-error">Выберите город.</p>
                }
              </div>

              <div class="field">
                <label class="label" for="district">Район / округ</label>
                <select class="control" id="district" name="district">
                  <option value="" selected>Не выбрано</option>
                  <option>Центральный</option>
                  <option>Северный</option>
                  <option>Южный</option>
                  <option>Западный</option>
                  <option>Восточный</option>
                </select>
              </div>
            </div>

            <div class="form-block field">
              <label class="label" for="address">Адрес (с подсказками) <span class="req">*</span></label>
              <input
                #addressField
                class="control"
                id="address"
                name="address"
                list="address-suggestions"
                placeholder="Введите адрес"
                required
                minlength="8"
                maxlength="180"
                [class.control--invalid]="showValidationErrors && !addressField.validity.valid" />
              @if (showValidationErrors && addressField.validity.valueMissing) {
              <p class="field-error">Введите адрес объекта.</p>
              } @if (showValidationErrors && !addressField.validity.valueMissing && addressField.validity.tooShort) {
              <p class="field-error">Адрес слишком короткий (минимум 8 символов).</p>
              }
              <datalist id="address-suggestions">
                <option value="Москва, Тверская ул., д. 10"></option>
                <option value="Москва, Ленинский пр-т, д. 45"></option>
                <option value="Санкт-Петербург, Невский пр-т, д. 28"></option>
                <option value="Казань, ул. Баумана, д. 5"></option>
                <option value="Екатеринбург, ул. Малышева, д. 16"></option>
              </datalist>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="legend">Основные параметры</legend>

            <div class="form-block grid grid--3">
              <div class="field">
                <label class="label" for="area">Площадь, м² <span class="req">*</span></label>
                <input
                  #areaField
                  class="control"
                  id="area"
                  name="area"
                  type="number"
                  required
                  min="1"
                  max="100000"
                  step="0.1"
                  inputmode="decimal"
                  placeholder="Например: 54.6"
                  [class.control--invalid]="showValidationErrors && !areaField.validity.valid" />
                @if (showValidationErrors && areaField.validity.valueMissing) {
                <p class="field-error">Укажите площадь объекта.</p>
                }
              </div>

              <div class="field">
                <label class="label" for="objectType">Тип объекта <span class="req">*</span></label>
                <select
                  #objectTypeField
                  class="control"
                  id="objectType"
                  name="objectType"
                  required
                  [class.control--invalid]="showValidationErrors && !objectTypeField.validity.valid">
                  <option value="" selected disabled>Выберите тип</option>
                  <option>Квартира</option>
                  <option>Дом</option>
                  <option>Комната</option>
                  <option>Апартаменты</option>
                  <option>Земельный участок</option>
                  <option>Коммерческая недвижимость</option>
                </select>
                @if (showValidationErrors && objectTypeField.validity.valueMissing) {
                <p class="field-error">Выберите тип объекта.</p>
                }
              </div>

              <div class="field">
                <label class="label" for="rooms">Кол-во комнат</label>
                <input
                  #roomsField
                  class="control"
                  id="rooms"
                  name="rooms"
                  type="number"
                  min="0"
                  max="50"
                  step="1"
                  inputmode="numeric"
                  placeholder="Например: 2"
                  [class.control--invalid]="showValidationErrors && !roomsField.validity.valid" />
                @if ( showValidationErrors && !roomsField.validity.valueMissing && (roomsField.validity.rangeUnderflow
                || roomsField.validity.rangeOverflow) ) {
                <p class="field-error">Количество комнат должно быть от 0 до 50.</p>
                }
              </div>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="legend">Характеристики</legend>

            <div class="form-block grid grid--3">
              <div class="field">
                <label class="label" for="floorsTotal">Этажность (всего этажей) <span class="req">*</span></label>
                <input
                  #floorsTotalField
                  class="control"
                  id="floorsTotal"
                  name="floorsTotal"
                  type="number"
                  required
                  min="1"
                  max="200"
                  step="1"
                  inputmode="numeric"
                  [class.control--invalid]="showValidationErrors && !floorsTotalField.validity.valid" />
                @if (showValidationErrors && floorsTotalField.validity.valueMissing) {
                <p class="field-error">Укажите общую этажность здания.</p>
                }
              </div>

              <div class="field">
                <label class="label" for="floor">Этаж</label>
                <input
                  class="control"
                  id="floor"
                  name="floor"
                  type="number"
                  min="0"
                  max="200"
                  step="1"
                  inputmode="numeric" />
                <div class="help">0 — если частный дом/участок.</div>
              </div>

              <div class="field">
                <label class="label" for="condition">Состояние <span class="req">*</span></label>
                <select
                  #conditionField
                  class="control"
                  id="condition"
                  name="condition"
                  required
                  [class.control--invalid]="showValidationErrors && !conditionField.validity.valid">
                  <option value="" selected disabled>Выберите</option>
                  <option>Новостройка</option>
                  <option>Хорошее</option>
                  <option>Требует ремонта</option>
                  <option>Аварийное</option>
                </select>
                @if (showValidationErrors && conditionField.validity.valueMissing) {
                <p class="field-error">Выберите состояние объекта.</p>
                }
              </div>

              <div class="field">
                <label class="label" for="yearBuilt">Год постройки</label>
                <input
                  class="control"
                  id="yearBuilt"
                  name="yearBuilt"
                  type="number"
                  min="1700"
                  max="2100"
                  step="1"
                  inputmode="numeric"
                  placeholder="Например: 2012" />
              </div>

              <div class="field">
                <label class="label" for="wallMaterial">Тип дома</label>
                <select class="control" id="wallMaterial" name="wallMaterial">
                  <option value="" selected>Не выбрано</option>
                  <option>Кирпичный</option>
                  <option>Панельный</option>
                  <option>Блочный</option>
                  <option>Монолитный</option>
                  <option>Монолитно-кирпичный</option>
                  <option>Деревянный</option>
                  <option>Газобетонный</option>
                </select>
              </div>

              <div class="field">
                <label class="label" for="elevator">Лифт</label>
                <select class="control" id="elevator" name="elevator">
                  <option value="" selected>Не выбрано</option>
                  <option>Нет</option>
                  <option>Грузовой</option>
                  <option>Пассажирский</option>
                  <option>Пассажирский и грузовой</option>
                </select>
              </div>
            </div>

            <div class="form-block field">
              <label class="label" for="description">Описание (доп. параметры)</label>
              <textarea
                class="control control--textarea"
                id="description"
                name="description"
                rows="4"
                maxlength="1000"
                placeholder="Например: вид из окна, парковка, санузел, наличие обременений (если известно)…"></textarea>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="legend">Документы и фото</legend>

            <div class="form-block grid grid--2">
              <div class="field">
                <label class="label" for="documentFiles">Сканы и документы <span class="req">*</span></label>
                <input
                  #documentFilesField
                  class="control control--file"
                  id="documentFiles"
                  name="documentFiles"
                  type="file"
                  accept=".pdf,.jpg,.jpeg,.png,.heic,.doc,.docx"
                  multiple
                  required
                  [class.control--invalid]="showValidationErrors && !documentFilesField.validity.valid"
                  (change)="onFilesSelected($event, 'documents')" />
                <div class="help">Поддерживаются PDF, DOC/DOCX и сканы/изображения (JPG, PNG, HEIC).</div>
                @if (showValidationErrors && documentFilesField.validity.valueMissing) {
                <p class="field-error">Загрузите хотя бы один документ или скан.</p>
                } @if (documentFiles.length) {
                <ul class="upload-list">
                  @for (file of documentFiles; track file.name + file.size + file.lastModified) {
                  <li class="upload-list__item">
                    <span class="upload-list__name">{{ file.name }}</span>
                    <span class="upload-list__meta">{{ formatFileSize(file.size) }}</span>
                  </li>
                  }
                </ul>
                }
              </div>

              <div class="field">
                <label class="label" for="photoFiles">Фото объекта</label>
                <input
                  class="control control--file"
                  id="photoFiles"
                  name="photoFiles"
                  type="file"
                  accept="image/*"
                  multiple
                  (change)="onFilesSelected($event, 'photos')" />
                <div class="help">Добавьте фото фасада, комнат и состояния объекта.</div>

                @if (photoFiles.length) {
                <ul class="upload-list">
                  @for (file of photoFiles; track file.name + file.size + file.lastModified) {
                  <li class="upload-list__item">
                    <span class="upload-list__name">{{ file.name }}</span>
                    <span class="upload-list__meta">{{ formatFileSize(file.size) }}</span>
                  </li>
                  }
                </ul>
                }
              </div>
            </div>

            <div class="form-block field">
              <label class="label" for="additionalFiles">Дополнительные файлы</label>
              <input
                class="control control--file"
                id="additionalFiles"
                name="additionalFiles"
                type="file"
                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"
                multiple
                (change)="onFilesSelected($event, 'additional')" />
              <div class="help">При необходимости добавьте доп. справки, планы или иные материалы.</div>

              @if (additionalFiles.length) {
              <ul class="upload-list">
                @for (file of additionalFiles; track file.name + file.size + file.lastModified) {
                <li class="upload-list__item">
                  <span class="upload-list__name">{{ file.name }}</span>
                  <span class="upload-list__meta">{{ formatFileSize(file.size) }}</span>
                </li>
                }
              </ul>
              }
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend class="legend">Подтверждения</legend>

            <label class="check">
              <input #confirmCorrect type="checkbox" name="confirmCorrect" required />
              <span>Подтверждаю, что данные введены корректно и соответствуют объекту.</span>
            </label>

            <label class="check">
              <input #confirmProcessing type="checkbox" name="confirmProcessing" required />
              <span>Согласен(на) на обработку данных для проведения оценки.</span>
            </label>
          </fieldset>
        </div>

        <div class="form__footer form__footer--center">
          <button
            class="btn btn--primary"
            type="submit"
            [disabled]="!confirmCorrect.checked || !confirmProcessing.checked">
            Сохранить параметры
          </button>
          <a class="btn btn--outline" href="./requests_table.html">Перейти к заявкам</a>
        </div>
      </form>
    </section>
  </main>
</div>
